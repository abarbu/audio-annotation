<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/html">
  <head>
    <title>Audio annotation</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" />
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css" />
    <!-- TODO This is not a CDN! -->
    <link
      rel="stylesheet"
      href="//cdnjs.cloudflare.com/ajax/libs/bootstrap-switch/3.1.0/css/bootstrap2/bootstrap-switch.css"
    />
    <link rel="stylesheet" href="bootstro.min.css" />
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery-url-parser/2.3.1/purl.min.js"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/d3/3.4.1/d3.min.js"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.15/lodash.min.js"></script>
    <script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery.hotkeys@0.1.0/jquery.hotkeys.min.js"></script>
    <script type="text/javascript" src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
    <!-- TODO This is not a CDN -->
    <script
      type="text/javascript"
      src="//cdnjs.cloudflare.com/ajax/libs/bootstrap-switch/3.1.0/js/bootstrap-switch.js"
    ></script>
    <script type="text/javascript" src="bootstro.min.js"></script>
    <link href="gui.css" rel="stylesheet" type="text/css" />
  </head>
  <body>
    <!-- https://waveform.prototyping.bbc.co.uk/waveform-data-issue-63/ -->
    <div id="firefoxisbad" class="display-none">
      <div id="firefoxisbadInner">Please use Chrome. Firefox has a bug with mp3s in decodeAudioData.</div>
    </div>
    <div class="toplevel">
      <div style="display: flex; flex-direction: row;">
        <div style="align-self: flex-start;flex: 1;">
          <button type="button" class="annotation-gui btn btn-warning btn-lg button-spacing" id="reset">
            Reset
          </button>
        </div>
        <div style="align-items: stretch;flex: 1;">
          <div id="loading">
            <h3></h3>
          </div>
        </div>
        <div id="submit-button" style="align-self: flex-start;flex: 1;">
          <button type="button" class="annotation-gui btn btn-success btn-lg button-spacing" id="submit">
            Submit
          </button>
        </div>
      </div>
      <div class="annotation-gui">
        <div class="panel panel-default">
          <div id="help-panel" class="panel-body">
            <div class="center">
              <button type="button" id="intro" class="btn btn-danger">
                Show me how to annotate words
              </button>
            </div>
          </div>
        </div>
        <div id="container-wrapper">
          <div id="container">
            <img class="img" id="spectrogram" alt="" style="height: 90%; width: 100%;" />
            <canvas id="waveform"></canvas>
            <canvas id="canvas"></canvas>
            <svg id="d3" preserveAspectRatio="none">
              <defs>
                <filter id="blackOutlineEffect">
                  <feMorphology in="SourceAlpha" result="MORPH" operator="dilate" radius="2" />
                  <feColorMatrix
                    in="MORPH"
                    result="DARKEN"
                    type="matrix"
                    values="0 0 0 0 0, 0 0 0 0 0, 0 0 0 0 0, 0 0 0 0.6 0"
                  />
                  <feMerge>
                    <feMergeNode in="DARKEN" />
                    <feMergeNode in="SourceGraphic" />
                  </feMerge>
                </filter>
              </defs>
            </svg>
          </div>
        </div>

        <div class="btn-toolbar center" id="controls-seeking" role="toolbar">
          <div class="btn-group" id="save-and-seek">
            <button type="button" class="btn btn-success" id="back-save-2-sec">
              1 <span class="shortcut">b</span>ack
            </button>
            <button type="button" class="btn btn-success" id="forward-save-2-sec">
              1 <span class="shortcut">f</span>orward
            </button>
          </div>
        </div>
        <div class = "row">
          <div class="dropdown text-center">
            <div id='labeloptions' class="btn-group row">
              <a id = 'labelbutton' class="btn btn-primary dropdown-toggle" data-toggle="dropdown" href="#">
                Top 10 labels for this scene
                <span class="caret"></span></a>
              <ul class="dropdown-menu">
              </ul>
            </div>
          </div>
        </div>

        <div id="label-autocomplete">
          <div id="label-entry">
            <input
              type="text"
              autocomplete="off"
              style="width: 50%; display: inline;"
              class="form-control"
              id="label-input"
              placeholder="Search for a label:"
            />
          </div>
        </div>

        <div class="row">
          <div class="center" style="padding: 4px;">
            <span class="legend">Special cases:</span>
            <span class="label label-default legend-label"
              >If you can't make out the scene class or no class seems to apply use '#' as a placeholder.</span
            >
          </div>
        </div>

        <div class="row">
          <div class="center">
            <div style="display: inline-block;">
              <button type="button" class="btn btn-primary" id="go-to-location" style="display: inline;">
                Go to
              </button>
              <input
                type="text"
                autocomplete="off"
                style="width: 8em; display: inline; text-align: right;"
                class="form-control"
                id="location-input"
                placeholder="Seconds"
                type="number"
              />
              <button
                type="button"
                class="btn btn-primary"
                style="margin-right: 30px;"
                id="go-to-last"
                style="display: inline;"
              >
                Go to last
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="center">
          <div style="display: inline-block;">
            <button type="button" class="btn btn-primary" id="change-user" style="display: inline;">
              Change user
            </button>
            <!-- NB Don't make this id username, it triggers password completion tools like lastpass -->
            <input
              type="text"
              autocomplete="off"
              style="width: 8em; display: inline; text-align: right;"
              class="form-control"
              id="worker-name"
              placeholder="USERNAME"
              type="number"
            />
          </div>
        </div>
      </div>
      <script type="text/javascript" src="gui.js"></script>
      <script>
        var all_labelList;
        $.ajax({'async': false,
          'global': false,
          'url': '/labels/alllabels.json',
          'dataType': "json",
          'success': function (data) {all_labelList = data;}
        });
        var allLabels;
        allLabels = [];
        Object.keys(all_labelList).forEach(function(key) {
          all_labelList[key].labels.forEach(function(label) {
            allLabels.push(label);
          });
        });

        function autocomplete(inp, arr) {
         /*the autocomplete function takes two arguments,
         the text field element and an array of possible autocompleted values:*/
         var currentFocus;
         /*execute a function when someone writes in the text field:*/
         inp.addEventListener("input", function(e) {
             var a, b, i, val = this.value;
             /*close any already open lists of autocompleted values*/
             closeAllLists();
             if (!val) { return false;}
             currentFocus = -1;
             /*create a DIV element that will contain the items (values):*/
             a = document.createElement("DIV");
             a.setAttribute("id", this.id + "autocomplete-list");
             a.setAttribute("class", "autocomplete-items");
             /*append the DIV element as a child of the autocomplete container:*/
             this.parentNode.appendChild(a);
             /*for each item in the array...*/
             for (i = 0; i < arr.length; i++) {
               /*check if the item starts with the same letters as the text field value:*/
               if (arr[i].substr(0, val.length).toUpperCase() == val.toUpperCase()) {
                 /*create a DIV element for each matching element:*/
                 b = document.createElement("DIV");
                 /*make the matching letters bold:*/
                 b.innerHTML = "<strong>" + arr[i].substr(0, val.length) + "</strong>";
                 b.innerHTML += arr[i].substr(val.length);
                 /*insert a input field that will hold the current array item's value:*/
                 b.innerHTML += "<input type='hidden' value='" + arr[i] + "'>";
                 /*execute a function when someone clicks on the item value (DIV element):*/
                     b.addEventListener("click", function(e) {
                     /*insert the value for the autocomplete text field:*/
                     inp.value = this.getElementsByTagName("input")[0].value;
                     /*close the list of autocompleted values,
                     (or any other open lists of autocompleted values:*/
                     closeAllLists();
                 });
                 a.appendChild(b);
               }
             }
         });
         /*execute a function presses a key on the keyboard:*/
         inp.addEventListener("keydown", function(e) {
             var x = document.getElementById(this.id + "autocomplete-list");
             if (x) x = x.getElementsByTagName("div");
             if (e.keyCode == 40) {
               /*If the arrow DOWN key is pressed,
               increase the currentFocus variable:*/
               currentFocus++;
               /*and and make the current item more visible:*/
               addActive(x);
             } else if (e.keyCode == 38) { //up
               /*If the arrow UP key is pressed,
               decrease the currentFocus variable:*/
               currentFocus--;
               /*and and make the current item more visible:*/
               addActive(x);
             } else if (e.keyCode == 13) {
               /*If the ENTER key is pressed, prevent the form from being submitted,*/
               e.preventDefault();
               if (currentFocus > -1) {
                 /*and simulate a click on the "active" item:*/
                 if (x) x[currentFocus].click();
               }
             }
         });
         function addActive(x) {
           /*a function to classify an item as "active":*/
           if (!x) return false;
           /*start by removing the "active" class on all items:*/
           removeActive(x);
           if (currentFocus >= x.length) currentFocus = 0;
           if (currentFocus < 0) currentFocus = (x.length - 1);
           /*add class "autocomplete-active":*/
           x[currentFocus].classList.add("autocomplete-active");
         }
         function removeActive(x) {
           /*a function to remove the "active" class from all autocomplete items:*/
           for (var i = 0; i < x.length; i++) {
             x[i].classList.remove("autocomplete-active");
           }
         }
         function closeAllLists(elmnt) {
           /*close all autocomplete lists in the document,
           except the one passed as an argument:*/
           var x = document.getElementsByClassName("autocomplete-items");
           for (var i = 0; i < x.length; i++) {
             if (elmnt != x[i] && elmnt != inp) {
             x[i].parentNode.removeChild(x[i]);
           }
          }
        }
       /*execute a function when someone clicks in the document:*/
       document.addEventListener("click", function (e) {
           closeAllLists(e.target);
       });
       }
       autocomplete(document.getElementById("label-input"), allLabels);

       $(".dropdown-menu li a").click(function(){
          var selectedText = $(this).text()
          $(this).parents('.btn-group').find('.dropdown-toggle')
              .html(selectedText + ' <span class="caret"></span>')
       });
      </script>
    </div>
  </body>
</html>
